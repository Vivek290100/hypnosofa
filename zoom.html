
const product = async (req, res) => {
    try {
        const user = req.session.user;
        let query = {}; 
        const searchQuery = req.query.q; 
        let sortCriteria = req.query.sort; 
        let categoryFilter = req.query.category;
        
        // Pagination
        const currentPage = parseInt(req.query.page) || 1; 
        const perPage = 8;
        const skip = (currentPage - 1) * perPage;

        if (searchQuery) {
            query.name = { $regex: new RegExp(searchQuery, 'i')  };
        }

        if (categoryFilter) {
            query.category = categoryFilter;
        }
        

        let sortOptions = {};
        switch (sortCriteria) {
            case 'price_low_high':
                sortOptions = { price: 1 };
                break;
            case 'price_high_low':
                sortOptions = { price: -1 };
                break;
            case 'name_a_z':
                sortOptions = { name: 1 };
                break;
            case 'name_z_a':
                sortOptions = { name: -1 };
                break;
            default:
                break;
        }

        // Count total number of products
        const totalProducts = await Product.countDocuments({ ...query, isDeleted: false });

        // Calculate total number of pages
        const totalPages = Math.ceil(totalProducts / perPage);

        const products = await Product.find({ ...query, isDeleted: false })
                                      .sort(sortOptions)
                                      .populate('category')
                                      .skip(skip)
                                      .limit(perPage);

        //product Offer
        const productoffer = await ProductOffer.find().select('discountPercentage product').exec();        
        // console.log('productoffer',productoffer);

       


        // Calculate discounted prices
        const discountedProducts = products.map(product => {
            const offer = productoffer.find(offer => offer.product.equals(product._id));
            const discountedPrice = offer ? product.price * (1 - offer.discountPercentage / 100) : product.price;
            return { ...product.toObject(), discountedPrice,offer };
        });

        // console.log('discountedProducts',discountedProducts); 

        const cartItemCount = req.session.cartItemCount;
        const categories = await Category.find(); 

      



        res.render('./user/products', {
            title: 'Products',
            products: discountedProducts,
            user,
            cartItemCount,
            categories,
            currentPage,
            sortCriteria,
            totalPages,
            
        });
    } catch (error) {
        console.error('Error fetching products:', error);
        res.status(500).render('error500');
    }
};
