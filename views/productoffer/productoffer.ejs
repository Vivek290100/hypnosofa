<!DOCTYPE html>
<html lang="en">
<%- include('../adminlayout/header') -%>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Offers</title>

    <link rel="stylesheet" href="/css/userList.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="/css/adminStyles.css">

    <style>
        .unblock-button {
            background:#004c3f;color:#fff;height:30px;font-size:10px;
            border-radius:4px;padding:0 8px;border:none;cursor:pointer;
        }
        input {
            color:#5e5e5e;font-size:smaller;width:100%;padding:4px;box-sizing:border-box;
        }
        .proname {font-size:smaller;width:fit-content;}

        .status-badge {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            color: #fff;
            z-index: 10;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.4s ease;
            white-space: nowrap;
        }
        .status-badge.show { opacity: 1; }
        .status-badge.success { background:#27ae60; }
        .status-badge.error   { background:#e74c3c; }

        .action-cell { position: relative; }
    </style>
</head>
<body>

    <%- include('../adminlayout/slider') -%>

    <section id="content">
        <%- include('../adminlayout/navbar') -%>

        <main>
            <table id="usersTable" class="table table-striped table-bordered" style="width:100%">
                <thead>
                    <tr>
                        <th>PRODUCT</th>
                        <th>DISCOUNT in %</th>
                        <th>START DATE</th>
                        <th>EXPIRES IN</th>
                        <th>UPDATE/DELETE</th>
                    </tr>
                </thead>
                <tbody>
                    <% products.forEach(product => { %>
                        <tr data-product-id="<%= product.productId %>">
                            <td class="proname text-wrap"><%= product.productName %></td>
                            <td>
                                <input type="number" id="offerInput_<%= product.productId %>" 
                                       value="<%= product.offerPercentage %>" 
                                       placeholder="%" min="0" max="99" />
                            </td>
                            <td>
                                <input type="date" id="startDateInput_<%= product.productId %>" 
                                       value="<%= product.startDate ? product.startDate.split('T')[0] : '' %>" />
                            </td>
                            <td>
                                <input type="date" id="expiryDateInput_<%= product.productId %>" 
                                       value="<%= product.expiryDate ? product.expiryDate.split('T')[0] : '' %>" />
                            </td>
                            <td class="d-flex align-items-center action-cell">
                                <button class="unblock-button" onclick="updateProductOffer('<%= product.productId %>', this)">
                                    Update
                                </button>
                                &nbsp;
                                <span onclick="deleteProductOffer('<%= product.productId %>', this)" 
                                      style="cursor:pointer;color:#e74c3c;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                                        <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                                    </svg>
                                </span>
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </main>
    </section>

    <%- include('../adminlayout/footer') -%>

    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap4.min.js"></script>

    <script>
        jQuery.noConflict();
        jQuery(document).ready(function($) {
            $('#usersTable').DataTable({
                pageLength: 10,
                lengthMenu: [10, 25, 50],
                order: [[0, 'asc']]
            });
        });
    </script>

    <script>
        function showStatus(element, message, type = 'success') {
            const old = element.parentElement.querySelector('.status-badge');
            if (old) old.remove();

            const badge = document.createElement('div');
            badge.className = `status-badge ${type}`;
            badge.textContent = message;
            element.parentElement.appendChild(badge);

            requestAnimationFrame(() => badge.classList.add('show'));

            setTimeout(() => {
                badge.classList.remove('show');
                badge.addEventListener('transitionend', () => badge.remove(), { once: true });
            }, 3000);
        }

        function updateProductOffer(productId, button) {
            const offer = document.getElementById(`offerInput_${productId}`).value.trim();
            const start = document.getElementById(`startDateInput_${productId}`).value;
            const expiry = document.getElementById(`expiryDateInput_${productId}`).value;

            if (!offer && !start && !expiry) {
                showStatus(button, 'Enter a value', 'error');
                return;
            }

            fetch(`/admin/edit-product-offer/${productId}/${start||'null'}/${expiry||'null'}/${offer||0}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(r => r.json())
            .then(d => {
                showStatus(button, d.success ? 'Updated!' : (d.message || 'Failed'), d.success ? 'success' : 'error');
            })
            .catch(() => showStatus(button, 'Network error', 'error'));
        }

        function deleteProductOffer(productId, icon) {

            fetch(`/admin/delete-product-offer/${productId}`, { method: 'DELETE' })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    showStatus(icon, 'Deleted', 'success');
                    setTimeout(() => location.reload(), 1200);
                } else {
                    showStatus(icon, d.message || 'Failed', 'error');
                }
            })
            .catch(() => showStatus(icon, 'Network error', 'error'));
        }

        document.querySelectorAll('.proname.text-wrap').forEach(el => {
            const text = el.textContent.trim();
            const chunks = [];
            for (let i = 0; i < text.length; i += 45) {
                chunks.push(text.substring(i, i + 45));
            }
            el.innerHTML = chunks.join('<br>');
        });
    </script>
</body>
</html>