

<!-- C:\Users\vivek_laxvnt1\Desktop\Tasks\Week 7-12 Project Week\hypnosofa\views\admin\orderlist.ejs -->
<!DOCTYPE html>
<html lang="en">
    <%- include('../adminlayout/header') -%>


    <head>
        <link rel="stylesheet" href="/css/userList.css">
    
         <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.css">
        <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap4.min.css">
    </head>

   
<body>
    


	<%- include('../adminlayout/slider') -%>



<section id="content">
        <%- include('../adminlayout/navbar') -%>

        <main>
            <div class="container">
                <div class="row">
                    <div class="col-md-12">
                        <h2>User Orders</h2>
                        <table id="usersTable" class="table table-striped table-bordered" style="width:100%">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>PRODUCTS</th> <!-- Changed from NAME -->
                                    <th>PRICE</th>
                                    <th>PAYMENT</th>
                                    <th>DATE & TIME</th>
                                    <th>STATUS</th>
                                    <th>VIEW</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (Orders.length > 0) { %>
                                    <% Orders.forEach((order, orderIndex) => { %>
                                        <% order.products.forEach((productItem, productIndex) => { %>
                                            <tr>
                                                <% if (productIndex === 0) { %>
                                                    <td rowspan="<%= order.products.length %>">
                                                        <%= (orderIndex + 1) + (currentPage - 1) * 5 %>
                                                    </td>

                                                    <!-- PRODUCTS CELL with rowspan -->
                                                    <td rowspan="<%= order.products.length %>" class="text-left">
                                                        <div class="product-list">
                                                            <% order.products.forEach(p => { %>
                                                                <div class="product-item">
                                                                    <span class="product-name"><%= p.product.name %></span>
                                                                    <span class="product-qty"> × <%= p.quantity %></span>
                                                                </div>
                                                            <% }) %>
                                                        </div>
                                                    </td>

                                                    <td rowspan="<%= order.products.length %>">
                                                        ₹ <%= order.totals.totalprice.toFixed(2) %>
                                                    </td>
                                                    <td rowspan="<%= order.products.length %>">
                                                        <%= order.paymentMethod %>
                                                    </td>
                                                    <td rowspan="<%= order.products.length %>">
                                                        <%= order.orderDate %>, <%= order.orderTime %>
                                                    </td>
                                                    <td rowspan="<%= order.products.length %>">
                                                        <form action="/updateOrderStatus" method="POST">
                                                            <input type="hidden" name="orderId" value="<%= order._id %>">
                                                            <select name="newStatus" class="status-select"
                                                                    <%= ['Cancelled', 'Delivered'].includes(order.status) ? 'disabled' : '' %>>
                                                                <option value="Pending" <%= order.status === 'Pending' ? 'selected' : '' %>>Pending</option>
                                                                <option value="Processing" <%= order.status === 'Processing' ? 'selected' : '' %>>Processing</option>
                                                                <option value="Shipped" <%= order.status === 'Shipped' ? 'selected' : '' %>>Shipped</option>
                                                                <option value="Delivered" <%= order.status === 'Delivered' ? 'selected' : '' %>>Delivered</option>
                                                                <option value="Cancelled" <%= order.status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
                                                            </select>
                                                            <button type="submit" class="btn btn-success btn-sm mt-1"
                                                                    <%= ['Cancelled', 'Delivered'].includes(order.status) ? 'disabled' : '' %>>
                                                                Update
                                                            </button>
                                                        </form>
                                                    </td>
                                                    <td rowspan="<%= order.products.length %>">
                                                        <a href="/order-details/<%= order._id %>"
                                                           class="btn btn-primary btn-sm">View Order</a>
                                                    </td>
                                                <% } %>
                                            </tr>
                                        <% }) %>
                                    <% }) %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="7" class="text-center">No orders found.</td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            <ul class="pagination1 d-flex justify-content-center mt-4">
                <% for (let i = 1; i <= totalPages; i++) { %>
                    <li class="page-item <%= currentPage == i ? 'active' : '' %>">
                        <a class="page-link" href="?page=<%= i %>"><%= i %></a>
                    </li>
                <% } %>
            </ul>
        </main>
    </section>
	
    </div>

    <script>
        window.alert = function() {};
    </script>
  


	<%- include('../adminlayout/footer') -%>
    

<script src="https://code.jquery.com/jquery-3.7.0.js"></script>


<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap4.min.js"></script>

    <script>
    jQuery.noConflict();
    jQuery(document).ready(function($) {
        $('#usersTable').DataTable();
        
    });
</script>


<script>
    $('form[action="/updateOrderStatus"]').on('submit', function(e) {
        e.preventDefault();
        const form = $(this);
        const orderId = form.find('input[name="orderId"]').val();
        const newStatus = form.find('select[name="newStatus"]').val();

        $.ajax({
            url: '/updateOrderStatus',
            method: 'POST',
            data: { orderId, newStatus },
            success: function(response) {
                alert('Status updated successfully!');
                location.reload(); 
            },
            error: function(xhr) {
                alert('Error updating status: ' + (xhr.responseText || 'Unknown error'));
            }
        });
    }); 
</script>

</body>
</html>