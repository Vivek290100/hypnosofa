<!DOCTYPE html>
<html lang="en">
<%- include('../adminlayout/header') -%>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coupon Management | Admin</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/userList.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap4.min.css">

    <style>
        /* === Action Buttons === */
        .edit, .unblock-button {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 60px;
        }
        .edit {
            background-color: #004c3f;
        }
        .edit:hover {
            background-color: #00382d;
            transform: translateY(-1px);
        }
        .unblock-button {
            background-color: #c43131;
        }
        .unblock-button:hover {
            background-color: #a02727;
            transform: translateY(-1px);
        }

        /* === Add Coupon Button === */
        .add-product {
            background-color: #28a745;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            transition: 0.2s;
        }
        .add-product:hover {
            background-color: #218838;
            transform: translateY(-1px);
        }

        /* === CENTERED MODAL – FULLY FIXED === */
        #confirmationModal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 30vw;
            height: 30vh;
            /* background: rgba(0, 0, 0, 0.5); */
            z-index: 9999;
            justify-content: center;
            align-items: center;
            /* backdrop-filter: blur(5px); */
            /* -webkit-backdrop-filter: blur(5px); */
            overflow: hidden;
        }
        #center-modal {
            background: #ffffff;
            padding: 28px;
            border-radius: 16px;
            text-align: center;
            width: 340px;
            max-width: 90%;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
            animation: modalPop 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.2);
            transform-origin: center;
        }
        @keyframes modalPop {
            from {
                transform: scale(0.75) translateY(20px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        #center-modal p {
            margin: 0 0 22px 0;
            font-size: 16px;
            font-weight: 500;
            color: #2c3e50;
            line-height: 1.5;
        }

        #confirmBtn, #cancelBtn {
            padding: 11px 22px;
            margin: 0 8px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.25s ease;
            min-width: 95px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        #confirmBtn {
            background: #004c3f;
            color: white;
        }
        #confirmBtn:hover {
            background: #00382d;
            transform: translateY(-2.5px);
            box-shadow: 0 6px 12px rgba(0,76,63,0.3);
        }
        #cancelBtn {
            background: #c43131;
            color: white;
        }
        #cancelBtn:hover {
            background: #a02727;
            transform: translateY(-2.5px);
            box-shadow: 0 6px 12px rgba(196,49,49,0.3);
        }

        /* === Inline Status Badge === */
        .action-cell {
            position: relative;
            min-height: 50px;
            text-align: center;
            padding: 8px 0;
        }
        .status-badge {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            padding: 7px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            color: #fff;
            z-index: 10;
            pointer-events: none;
            opacity: 0;
            transition: all 0.4s ease;
            white-space: nowrap;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        .status-badge.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        .status-badge.success {
            background: linear-gradient(135deg, #27ae60, #1e8449);
        }
        .status-badge.error {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        /* === Table Enhancements === */
        .table thead th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }
        .table td {
            vertical-align: middle;
            font-size: 14px;
        }
        .table .action-cell {
            white-space: nowrap;
        }
    </style>
</head>

<body>
    <!-- SIDEBAR -->
    <%- include('../adminlayout/slider') -%>

    <!-- CONTENT -->
    <section id="content">
        <%- include('../adminlayout/navbar') -%>

        <main class="p-4">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="mb-0 text-dark font-weight-bold">Coupon Management</h3>
                <a href="/coupons/add">
                    <button class="add-product btn">Add Coupon</button>
                </a>
            </div>

            <!-- Table Card -->
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table id="usersTable" class="table table-hover mb-0" style="width:100%">
                            <thead>
                                <tr>
                                    <th>COUPON CODE</th>
                                    <th>DISCOUNT</th>
                                    <th>MIN AMOUNT</th>
                                    <th>START DATE</th>
                                    <th>EXPIRES IN</th>
                                    <th>ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% coupons.forEach(coupon => { %>
                                    <tr data-coupon-id="<%= coupon._id %>">
                                        <td><strong class="text-primary"><%= coupon.couponCode %></strong></td>
                                        <td>₹<%= coupon.discountAmount %></td>
                                        <td>₹<%= coupon.minPurchaseAmount %></td>
                                        <td><%= new Date(coupon.startDate).toLocaleDateString('en-GB') %></td>
                                        <td><%= new Date(coupon.expiryDate).toLocaleDateString('en-GB') %></td>
                                        <td class="action-cell">
                                            <a href="/edit-coupon/<%= coupon._id %>" class="edit mr-2">Edit</a>
                                            <button class="unblock-button delete-btn" data-id="<%= coupon._id %>">Delete</button>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </section>

    <!-- CENTERED CONFIRMATION MODAL -->
    <div id="confirmationModal">
        <div id="center-modal">
            <p>Are you sure you want to delete this coupon?</p>
            <div>
                <button id="confirmBtn">Confirm</button>
                <button id="cancelBtn">Cancel</button>
            </div>
        </div>
    </div>

    <%- include('../adminlayout/footer') -%>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap4.min.js"></script>

    <script>
        jQuery.noConflict();
        jQuery(document).ready(function($) {
            $('#usersTable').DataTable({
                pageLength: 10,
                lengthMenu: [10, 25, 50, 100],
                order: [[0, 'asc']],
                columnDefs: [
                    { targets: 5, orderable: false, width: "140px" }
                ],
                language: {
                    search: "",
                    searchPlaceholder: "Search coupons..."
                }
            });
        });
    </script>

    <script>
        // === Modal & Delete Logic ===
        const modal = document.getElementById("confirmationModal");
        const confirmBtn = document.getElementById("confirmBtn");
        const cancelBtn = document.getElementById("cancelBtn");
        let currentCouponId = null;
        let currentActionCell = null;

        // Open modal
        document.querySelectorAll(".delete-btn").forEach(btn => {
            btn.addEventListener("click", function(e) {
                e.preventDefault();
                currentCouponId = this.dataset.id;
                currentActionCell = this.closest('.action-cell');
                modal.style.display = "flex";
            });
        });

        // Close modal
        const closeModal = () => modal.style.display = "none";
        cancelBtn.onclick = closeModal;
        window.addEventListener("click", (e) => {
            if (e.target === modal) closeModal();
        });
        window.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && modal.style.display === "flex") {
                closeModal();
            }
        });

        // Confirm delete
        confirmBtn.onclick = async () => {
            if (!currentCouponId || !currentActionCell) return;

            modal.style.display = "none"; // Hide instantly

            try {
                const res = await fetch(`/delete-coupons/${currentCouponId}`, {
                    method: "DELETE"
                });
                const data = await res.json();

                showStatus(
                    currentActionCell,
                    data.success ? 'Deleted!' : (data.message || 'Failed'),
                    data.success ? 'success' : 'error'
                );

                if (data.success) {
                    setTimeout(() => location.reload(), 1300);
                }
            } catch (err) {
                console.error("Delete error:", err);
                showStatus(currentActionCell, 'Network error', 'error');
            }
        };

        // === Inline Status Badge ===
        function showStatus(cell, message, type = 'success') {
            // Remove old
            const old = cell.querySelector('.status-badge');
            if (old) old.remove();

            const badge = document.createElement('div');
            badge.className = `status-badge ${type}`;
            badge.textContent = message;
            cell.appendChild(badge);

            requestAnimationFrame(() => badge.classList.add('show'));

            setTimeout(() => {
                badge.classList.remove('show');
                badge.addEventListener('transitionend', () => badge.remove(), { once: true });
            }, 3000);
        }
    </script>
</body>
</html>