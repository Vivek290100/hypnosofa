<!DOCTYPE html>
<html lang="en">
<%- include('../adminlayout/header') -%>
<head>
  <link rel="stylesheet" href="/css/userList.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap4.min.css">
  <style>
    .modal { 
      display: none; 
      position: fixed; 
      z-index: 1000; 
      left: 0; top: 0; 
      width: 100%; height: 100%; 
      background: rgba(0,0,0,0.4); 
      justify-content: center; 
      align-items: center;
    }
    .modal-content { 
      background: #fefefe; 
      padding: 20px; 
      border: 1px solid #888; 
      width: 80%; 
      max-width: 500px; 
      border-radius: 8px; 
      text-align: center;
    }
    .close { 
      color: #aaa; 
      float: right; 
      font-size: 28px; 
      font-weight: bold; 
      cursor: pointer; 
    }
    .close:hover { color: #000; }
    #confirmDeleteBtn { 
      background: #004c3f; 
      color: #fff; 
      padding: 8px 16px; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
    }
    #cancelDeleteBtn { 
      background: #c43131; 
      color: #fff; 
      padding: 8px 16px; 
      border: none; 
      border-radius: 4px; 
      margin-left: 10px; 
      cursor: pointer; 
    }

    /* Inline Status Badge */
    .action-cell { position: relative; min-height: 40px; }
    .status-badge {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      color: #fff;
      z-index: 10;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.4s ease;
      white-space: nowrap;
    }
    .status-badge.show { opacity: 1; }
    .status-badge.success { background:#27ae60; }
    .status-badge.error   { background:#e74c3c; }
  </style>
</head>
<body>
  <%- include('../adminlayout/slider') -%>

  <section id="content">
    <%- include('../adminlayout/navbar') -%>

    <main>
      <a href="/addform" class="btn btn-success mb-3">Add Product</a>

      <table id="usersTable" class="table table-striped table-bordered" style="width:100%">
        <thead>
          <tr>
            <th>No</th>
            <th>Name</th>
            <th>Description</th>
            <th>Image</th>
            <th>Price</th>
            <th>Category</th>
            <th>Quantity</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% products.forEach((p, i) => { %>
            <tr data-product-id="<%= p._id %>">
              <td><%= i + 1 %></td>
              <td><%= p.name %></td>
              <td class="description"><%= p.description %></td>
              <td>
                <% p.images.forEach(img => { %>
                  <img src="<%= img %>" alt="Product" style="width:50px; height:50px; object-fit:cover; margin:2px;">
                <% }) %>
              </td>
              <td>₹<%= p.price %></td>
              <td><%= p.category ? p.category.name : '—' %></td>
              <td><%= p.quantity || 0 %></td>
              <td class="action-cell">
                <a href="/product/editform/<%= p._id %>" class="btn btn-sm btn-primary">Edit</a>
                <a href="#" class="btn btn-sm btn-danger delete-button" data-product-id="<%= p._id %>">Delete</a>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </main>
  </section>

  <!-- DELETE CONFIRMATION MODAL -->
  <div id="deleteProductModal" class="modal">
    <div class="modal-content">
      <span class="close">×</span>
      <p style="margin:15px 0; font-size:15px;">Are you sure you want to delete this product?</p>
      <button id="confirmDeleteBtn">Confirm</button>
      <button id="cancelDeleteBtn">Cancel</button>
    </div>
  </div>

  <%- include('../adminlayout/footer') -%>

  <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap4.min.js"></script>

  <script>
    $(document).ready(function() {
      $('#usersTable').DataTable();
    });

    // Truncate long description
    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll(".description").forEach(cell => {
        let txt = cell.textContent.trim();
        if (txt.length > 50) {
          cell.textContent = txt.substring(0, 50) + "...";
        }
      });
    });

    // === Inline Status Badge ===
    function showStatus(cell, message, type = 'success') {
      const old = cell.querySelector('.status-badge');
      if (old) old.remove();

      const badge = document.createElement('div');
      badge.className = `status-badge ${type}`;
      badge.textContent = message;
      cell.appendChild(badge);

      requestAnimationFrame(() => badge.classList.add('show'));

      setTimeout(() => {
        badge.classList.remove('show');
        badge.addEventListener('transitionend', () => badge.remove(), { once: true });
      }, 3000);
    }

    // === Delete Modal Logic ===
    const modal = document.getElementById("deleteProductModal");
    const closeBtn = document.querySelector(".close");
    const confirmBtn = document.getElementById("confirmDeleteBtn");
    const cancelBtn = document.getElementById("cancelDeleteBtn");
    let currentProductId = null;
    let currentActionCell = null;

    // Open modal on Delete click
    document.querySelectorAll(".delete-button").forEach(btn => {
      btn.addEventListener("click", e => {
        e.preventDefault();
        currentProductId = btn.dataset.productId;
        currentActionCell = btn.closest('.action-cell');
        modal.style.display = "flex"; // show modal
      });
    });

    // Close modal
    closeBtn.onclick = () => modal.style.display = "none";
    cancelBtn.onclick = () => modal.style.display = "none";
    window.onclick = e => {
      if (e.target === modal) modal.style.display = "none";
    };

    // Confirm delete
    confirmBtn.onclick = async () => {
      if (!currentProductId || !currentActionCell) return;
modal.style.display = "none";
      try {
        const res = await fetch(`/product/deleteproduct/${currentProductId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        showStatus(
          currentActionCell,
          data.success ? 'Deleted!' : (data.message || 'Failed'),
          data.success ? 'success' : 'error'
        );

        if (data.success) {
          setTimeout(() => location.reload(), 1200);
        }
      } catch (err) {
        console.error(err);
        showStatus(currentActionCell, 'Network error', 'error');
      } finally {
        modal.style.display = "none";
      }
    };
  </script>
</body>
</html>